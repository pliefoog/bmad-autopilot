<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-11</epicId>
    <storyId>11.3</storyId>
    <title>Automatic Simulator Discovery</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-10-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-11.3-automatic-simulator-discovery.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>test developer</asA>
    <iWant>automatic NMEA Bridge Simulator discovery and connection management</iWant>
    <soThat>I can run comprehensive integration tests without manual simulator configuration</soThat>
    <tasks>
      <task id="1" name="SimulatorTestClient Implementation" acs="AC1:1-5,AC4:1-5">
        <subtask id="1.1" name="Port discovery and connection establishment">Implement auto-discovery on ports [9090, 8080] with 5-second timeout, Add 3 retry attempts with exponential backoff (100ms, 200ms, 400ms delays), Create connection validation and health check endpoints</subtask>
        <subtask id="1.2" name="HTTP API communication layer">Implement scenario loading via POST /api/scenarios, Add NMEA message injection via POST /api/inject-data, Create simulator status endpoint GET /api/status</subtask>
        <subtask id="1.3" name="WebSocket connection management">Real-time data stream handling with automatic reconnection, Connection pooling for test environment isolation, Thread-safe connection management for parallel tests</subtask>
      </task>
      <task id="2" name="Graceful Fallback and Mock Integration" acs="AC1:3,AC3:4">
        <subtask id="2.1" name="Mock mode implementation">Automatic fallback when simulator unavailable, Mock NMEA data generation matching simulator patterns, Test execution continuity in offline development environments</subtask>
        <subtask id="2.2" name="Error handling and recovery">Robust connection error handling with meaningful error messages, Resource cleanup and connection disposal, Timeout handling with configurable thresholds</subtask>
      </task>
      <task id="3" name="VS Code Test Explorer Integration" acs="AC2:1-5">
        <subtask id="3.1" name="Test explorer UI enhancement">Simulator connection status display in test explorer, Real-time availability indicators with color coding, Test categorization based on simulator availability</subtask>
        <subtask id="3.2" name="Performance monitoring integration">Performance threshold warnings during test execution, Test execution timing and bottleneck identification, Coverage visualization with marine safety focus areas</subtask>
      </task>
      <task id="4" name="Environment Auto-Configuration" acs="AC3:1-5">
        <subtask id="4.1" name="Infrastructure detection">Automatic detection of available testing services, Dynamic test suite configuration, Environment-specific execution planning</subtask>
        <subtask id="4.2" name="Epic 7/10 simulator integration">Integration with existing NMEA Bridge Simulator API, Leverage established scenario library from marine-assets/test-scenarios/, Maintain compatibility with existing test infrastructure</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="AC1" name="SimulatorTestClient Auto-Discovery (Core Functionality)">
      <criterion id="1">Automatic discovery on ports [9090, 8080] with 5-second timeout</criterion>
      <criterion id="2">Connection establishment with 3 retry attempts and exponential backoff</criterion>
      <criterion id="3">Graceful fallback to mock mode if simulator unavailable</criterion>
      <criterion id="4">HTTP API communication for scenario loading and NMEA injection</criterion>
      <criterion id="5">WebSocket connection management for real-time data streams</criterion>
    </ac>
    <ac id="AC2" name="VS Code Test Explorer Integration (Developer Experience)">
      <criterion id="1">Simulator connection status display in test explorer UI</criterion>
      <criterion id="2">Real-time simulator availability indicators</criterion>
      <criterion id="3">Automatic test categorization based on simulator availability</criterion>
      <criterion id="4">Performance monitoring integration with threshold warnings</criterion>
      <criterion id="5">Native Jest test discovery with simulator status annotations</criterion>
    </ac>
    <ac id="AC3" name="Test Environment Auto-Configuration (Infrastructure)">
      <criterion id="1">Automatic detection of available testing infrastructure</criterion>
      <criterion id="2">Dynamic test suite configuration based on available services</criterion>
      <criterion id="3">Environment-specific test execution planning</criterion>
      <criterion id="4">Robust error handling and recovery mechanisms</criterion>
      <criterion id="5">Integration with existing Epic 7/10 NMEA Bridge Simulator API</criterion>
    </ac>
    <ac id="AC4" name="Connection Management and Resilience (Reliability)">
      <criterion id="1">Connection pooling for test environment isolation</criterion>
      <criterion id="2">Automatic reconnection on connection drops</criterion>
      <criterion id="3">Resource cleanup and connection disposal</criterion>
      <criterion id="4">Timeout handling with configurable thresholds</criterion>
      <criterion id="5">Thread-safe connection management for parallel test execution</criterion>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path=".github/copilot-instructions.md" title="GitHub Copilot Instructions" section="Simulator Control API Reference" snippet="Port: 9090 (Use 'Simulator Control API' naming). Endpoints: /api/scenarios/, /api/inject-data, /api/simulate-error. External Control: Use REST API, not direct CLI commands."/>
      <doc path="docs/tech-spec-epic-11.md" title="Epic 11 Technical Specification" section="APIs and Interfaces" snippet="Simulator Control API (Port 9090): GET /api/status, POST /api/inject-data, POST /api/scenarios/{scenario_name}/start, POST /api/simulate-error. Test Client Interface with autoConnect(options?: SimulatorConfig): Promise<SimulatorTestClient>."/>
      <doc path="docs/nmea-bridge-simulator-architecture.md" title="NMEA Bridge Simulator Architecture" section="Cross-Platform Validation" snippet="Multi-platform integration tests with WebSocket clients on port 8080 and TCP clients on port 10110. Simulator validation tests with scenario engine and NMEA sentence generation."/>
      <doc path="docs/nmea-research-findings.md" title="NMEA Protocol Research" section="Integration Testing" snippet="WiFi bridge connection tests with graceful disconnection handling. Tests use connection.connect('192.168.1.10', 10110) patterns and simulate power loss scenarios."/>
      <doc path="TESTING-STRATEGY.md" title="Testing Strategy" section="Integration Tests" snippet="Connection resilience tests with automatic reconnection and exponential backoff. Test execution requires NMEA Bridge Simulator: 'node server/nmea-bridge-simulator.js --scenario basic-navigation --api-port 9090'."/>
      <doc path="boatingInstrumentsApp/server/README-SIMULATOR.md" title="NMEA Bridge Simulator Usage" section="Client Connection Examples" snippet="TCP Client (React Native): TcpSocket.createConnection port 2000. WebSocket Client (Web): new WebSocket('ws://localhost:8080'). API control via port 9090 endpoints."/>
    </docs>
    <code>
      <code path="boatingInstrumentsApp/src/testing/helpers/SimulatorTestClient.ts" kind="test-client" symbol="SimulatorTestClient" lines="1-100" reason="Existing autoConnect implementation with ports [9090, 8080], 5-second timeout, and retry logic. Base for Story 11.3 enhancements with VS Code Test Explorer integration."/>
      <code path="boatingInstrumentsApp/server/nmea-bridge-simulator.js" kind="simulator-server" symbol="NMEABridgeSimulator" lines="32-100" reason="Multi-protocol server with TCP (port 2000), WebSocket (port 8080), and API control. Port constants: UDP_PORT=2000, WS_PORT=8080, BIND_HOST='0.0.0.0' for auto-discovery integration."/>
      <code path="boatingInstrumentsApp/jest.config.js" kind="test-config" symbol="Jest Configuration" lines="1-100" reason="Triple-tier testing architecture with tier1-unit, tier2-integration, tier3-e2e test patterns. Coverage thresholds: widgets 85%, services 80%, integration 90%. VS Code Test Explorer integration ready."/>
      <code path="boatingInstrumentsApp/__tests__/nmea-bridge-simulator-integration.test.ts" kind="integration-test" symbol="NMEA Bridge Simulator Integration Tests" lines="1-100" reason="WebSocket message format testing and autopilot command processing patterns. Template for SimulatorTestClient auto-discovery integration testing."/>
      <code path="boatingInstrumentsApp/__tests__/nmea-bridge-simulator-network.test.ts" kind="network-test" symbol="Real Network Integration Tests" lines="1-50" reason="Real process startup with spawn, port binding validation, connection timeout handling (STARTUP_TIMEOUT = 10000ms). Network integration patterns for auto-discovery implementation."/>
      <code path="boatingInstrumentsApp/server/bmad-integration-api.js" kind="api-server" symbol="BMADIntegrationAPI" lines="32-60" reason="BMAD Integration API server on port 9090. Provides /api/status, /api/inject-data endpoints. Auto-discovery target server for SimulatorTestClient connection management."/>
    </code>
    <dependencies>
      <node>
        <testing>jest: ^29.7.0, @types/jest: ^29.5.13, @testing-library/react-native: ^13.3.3, supertest: ^7.1.4</testing>
        <network>ws: ^8.18.1, react-native-tcp-socket: ^6.3.0, react-native-udp: ^4.1.7</network>
        <react-native>react-native: ^0.81.4, expo: ^54.0.20, @expo/cli: ^54.0.11</react-native>
        <state-management>zustand: ^5.0.8</state-management>
        <nmea>@canboat/canboatjs: ^3.11.0, nmea-simple: ^3.3.0</nmea>
        <http-server>express: ^5.1.0, cors: ^2.8.5</http-server>
        <yaml-processing>js-yaml: ^4.1.0, yaml: ^2.8.1</yaml-processing>
        <dev-tools>typescript: ^5.8.3, @types/node: ^20.19.21, @types/ws: ^8.18.1</dev-tools>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - Built on Epic 7/10 NMEA Bridge Simulator infrastructure with established API patterns
    - Integrates with Triple-Tier Testing Architecture from Story 11.1 (Static Mocks, API Injection, Full Scenario)
    - Follows Epic 6 domain separation principles (navigation, engine, environment, autopilot, core)
    - Maintains React Native cross-platform testing compatibility
    - Performance Requirements: <2000ms per integration test scenario, <5-second discovery timeout
    - Coverage Standards: Integration coverage â‰¥90% for end-to-end marine data workflows
    - Marine Safety Compliance: Automatic fallback ensures 99.5% test execution reliability
    - VS Code Test Explorer integration requirements for real-time status display
  </constraints>
  <interfaces>
    <interface name="ISimulatorTestClient" kind="test client interface" signature="autoConnect(options?: SimulatorConfig): Promise<SimulatorTestClient>; isConnected(): boolean; injectNmeaMessage(sentence: string): Promise<void>; startScenario(name: string): Promise<void>; disconnect(): Promise<void>" path="boatingInstrumentsApp/src/testing/helpers/SimulatorTestClient.ts"/>
    <interface name="Simulator Control API" kind="HTTP REST API" signature="GET /api/status; POST /api/inject-data; POST /api/scenarios/{scenario_name}/start; POST /api/simulate-error" path="Port 9090 - NMEA Bridge Simulator"/>
    <interface name="WebSocket Bridge" kind="WebSocket API" signature="Real-time NMEA data streaming with message format {type: 'nmea', data: string, timestamp: number}" path="Port 8080 - Web platform integration"/>
    <interface name="Jest Test Explorer" kind="VS Code extension API" signature="Test discovery, status display, coverage overlay, performance monitoring integration" path=".vscode/settings.json and jest.config.js"/>
  </interfaces>
  <tests>
    <standards>Jest (^29.7.0) as primary test runner with React Native preset, @testing-library/react-native for component testing, supertest (^7.1.4) for API endpoint testing, triple-tier architecture (Static Mocks <50ms, API Injection <2000ms, Full Scenario <30s), professional documentation headers with PURPOSE/REQUIREMENT/METHOD/EXPECTED format per Story 11.4 standards, VS Code Test Explorer integration with real-time simulator status indicators and coverage visualization.</standards>
    <locations>boatingInstrumentsApp/__tests__/ (main test directory with tier1-unit/, tier2-integration/, tier3-e2e/ subdirectories), boatingInstrumentsApp/src/testing/helpers/ (test utilities including SimulatorTestClient), marine-assets/test-scenarios/ (YAML scenario library for integration testing), .vscode/settings.json and jest.config.js (VS Code Test Explorer configuration), boatingInstrumentsApp/server/test/ (simulator server tests)</locations>
    <ideas>
      <idea ac="AC1">Port discovery and connection establishment testing: Create test suite for SimulatorTestClient.autoConnect() with ports [9090, 8080] discovery, validate 5-second timeout behavior with AbortSignal.timeout(), test 3 retry attempts with exponential backoff (1000ms, 1500ms, 2250ms), verify graceful fallback to mock mode when simulator unavailable, test connection validation with GET /api/status endpoint</idea>
      <idea ac="AC1">HTTP API communication testing: Test scenario loading via POST /api/scenarios/load with supertest, validate NMEA message injection via POST /api/inject-data, test simulator status endpoint GET /api/status response validation, verify WebSocket connection management on port 8080 for real-time data streams, test error handling for invalid API requests</idea>
      <idea ac="AC2">VS Code Test Explorer integration testing: Mock VS Code extension APIs for simulator connection status display, test real-time availability indicators with color coding (green=connected, red=unavailable, yellow=connecting), validate automatic test categorization based on simulator availability (unit vs integration test filtering), verify performance monitoring integration with threshold warnings, test Jest test discovery with simulator status annotations</idea>
      <idea ac="AC3">Test environment auto-configuration testing: Test automatic detection of running NMEA Bridge Simulator via port scanning, validate dynamic test suite configuration based on available services (full integration vs mock-only), verify environment-specific execution planning (CI vs local development), test robust error handling and recovery mechanisms, validate integration with Epic 7/10 NMEA Bridge Simulator API patterns</idea>
      <idea ac="AC4">Connection management and resilience testing: Test connection pooling for test environment isolation using Map-based client tracking, validate automatic reconnection on connection drops with exponential backoff retry logic, verify resource cleanup and connection disposal via cleanup hooks, test timeout handling with configurable thresholds (5-second default), test thread-safe connection management for parallel test execution without resource conflicts</idea>
    </ideas>
  </tests>
</story-context>