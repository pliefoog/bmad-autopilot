<?xml version="1.0" encoding="UTF-8"?>
<story-context id="bmad/bmm/workflows/4-implementation/story-context/2.14" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.14</storyId>
    <title>Simple Theme System - Brownfield Addition</title>
    <status>Ready for Development</status>
    <generatedAt>2025-01-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-2.14-marine-compliant-theme-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>recreational boater using the app in different lighting conditions</asA>
    <iWant>simple day and night display modes</iWant>
    <soThat>the screen is comfortable to view in bright sunlight and low light conditions</soThat>
    <tasks>
      - Phase 1 Foundation (Extend ThemeProvider with marine-safe color palettes, Create theme compliance validation system)
      - Phase 2 Platform Integration (Implement native brightness control integration)
      - Phase 3 Integration & Testing (Update existing components for new theme modes)
    </tasks>
  </story>

  <acceptanceCriteria>
    <functional_requirements>
      <item id="1">Implement simple Day and Night display modes</item>
      <item id="2">Day mode: bright, high contrast colors for sunlight viewing</item>
      <item id="3">Night mode: dark background with reduced brightness for low light use</item>
      <item id="4">Simple theme switching accessible from settings menu</item>
    </functional_requirements>
    <integration_requirements>
      <item id="5">Existing theme infrastructure continues to work unchanged</item>
      <item id="6">New theme modes follow existing theme provider pattern</item>
      <item id="7">Integration with all existing widgets maintains current behavior</item>
      <item id="8">All existing components automatically inherit new theme modes</item>
    </integration_requirements>
    <quality_requirements>
      <item id="9">Theme switches complete smoothly without flickering</item>
      <item id="10">Performance impact is negligible during theme switches</item>
      <item id="11">Traditional marine equipment color schemes for familiarity</item>
    </quality_requirements>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <item path="docs/prd.md" title="Product Requirements Document" section="User Value Theme" snippet="Display modes (day/night/red-night) for marine instrument visibility in all lighting conditions. Marine-compliant interface design following traditional equipment patterns."/>
      <item path="docs/ui-architecture.md" title="UI Architecture Document" section="Theme System" snippet="Marine-compliant red-night theme system, comprehensive widget state management, native brightness integration, theme compliance validation, complete UI component coverage."/>
      <item path="docs/stories/story-2.8-theme-switcher.md" title="Story 2.8: Theme Switcher" section="Implementation" snippet="Theme switching infrastructure with hamburger menu integration and existing theme provider pattern."/>
      <item path="docs/stories/story-2.10-theme-integration.md" title="Story 2.10: Theme Integration" section="Theme System" snippet="Centralized theme system with day/night/red-night modes - provides theme properties for widget integration."/>
      <item path="docs/stories/story-2.14-marine-compliant-theme-system.md" title="Story 2.14: Marine Theme System" section="Dev Notes" snippet="Marine Safety Requirements: Red-Night mode CRITICAL for night vision preservation. Must emit zero blue/green light (wavelengths below 620nm). Brightness reduction: Day (100%) → Night (40%) → Red-Night (20%)."/>
    </docs>
    <code>
      <item path="boatingInstrumentsApp/src/store/themeStore.ts" kind="store" symbol="useThemeStore" lines="1-281" reason="Core theme system with native brightness control integration - already implements AC 1-3, 5-6, 9-10 with marine-compliant color palettes"/>
      <item path="boatingInstrumentsApp/src/utils/themeCompliance.ts" kind="utility" symbol="analyzeColorCompliance" lines="1-175" reason="Theme compliance validation system - already implements marine safety validation for red-night mode and blue/green light detection"/>
      <item path="boatingInstrumentsApp/src/widgets/ThemeSwitcher.tsx" kind="widget" symbol="ThemeSwitcher" lines="1-244" reason="Theme switching UI component - already implements AC 4, 8 with native brightness control and theme mode selection"/>
      <item path="boatingInstrumentsApp/src/theme/ThemeProvider.tsx" kind="component" symbol="ThemeProvider" reason="Theme context provider component following existing theme provider pattern (AC 6-7)"/>
      <item path="boatingInstrumentsApp/src/theme/colors.ts" kind="constants" symbol="dayTheme" reason="Marine-safe color palette definitions for Day/Night/Red-Night modes (AC 2-3, 11)"/>
      <item path="boatingInstrumentsApp/__tests__/themeCompliance.test.ts" kind="test" symbol="themeComplianceTests" reason="Comprehensive test suite covering marine safety compliance scenarios with 11 passing tests"/>
    </code>
    <dependencies>
      <expo>
        <package name="expo" version="^54.0.13" usage="Expo framework with brightness control integration"/>
        <package name="expo-brightness" version="^14.0.7" usage="Native brightness control API for marine-compliant brightness levels (Day: 100%, Night: 40%, Red-Night: 20%)"/>
        <package name="expo-router" version="^6.0.12" usage="Navigation framework with theme integration"/>
      </expo>
      <react_native>
        <package name="react-native" version="^0.81.4" usage="Core framework with StyleSheet API for theme-aware styling"/>
        <package name="react-native-vector-icons" version="^10.3.0" usage="Icon system for theme mode indicators (sunny, moon, eye icons)"/>
      </react_native>
      <state>
        <package name="zustand" version="^5.0.8" usage="State management for theme mode persistence and brightness control"/>
        <package name="@react-native-async-storage/async-storage" version="^2.2.0" usage="Persistent storage for theme preferences and brightness settings"/>
      </state>
    </dependencies>
  </artifacts>

  <constraints>
    - Marine Safety Standards: Red-Night mode must emit ZERO blue/green light (wavelengths below 620nm) for night vision preservation
    - Brightness Requirements: Marine-compliant brightness levels (Day: 100%, Night: 40%, Red-Night: 20%) using Expo Brightness API
    - Performance Standards: Theme switches must complete <100ms without flickering or delays
    - Traditional Marine Colors: Color schemes must match familiar marine equipment (depth sounders, GPS units, radar displays)
    - Theme Infrastructure Compatibility: Must integrate with existing theme provider pattern without breaking changes
    - Cross-Platform Native APIs: iOS and Android brightness control with web platform fallbacks
    - Development Validation: Theme compliance validation system runs in development mode only
    - Component Integration: All existing widgets must automatically inherit new theme modes
    - Color Purity: Red-Night theme uses only pure red spectrum colors (#FF0000, #CC0000, etc.)
    - Night Vision Preservation: Red light preserves rhodopsin in retinal rods for 30+ minutes per marine standards
  </constraints>
  
  <interfaces>
    <item name="ThemeMode" kind="type" signature="type ThemeMode = 'day' | 'night' | 'red-night' | 'auto'" path="boatingInstrumentsApp/src/store/themeStore.ts"/>
    <item name="useThemeStore" kind="hook" signature="function useThemeStore(): { mode: ThemeMode; brightness: number; nativeBrightnessControl: boolean; setMode: (mode: ThemeMode) => void; setBrightness: (brightness: number) => void; toggleNativeBrightnessControl: () => void; }" path="boatingInstrumentsApp/src/store/themeStore.ts"/>
    <item name="analyzeColorCompliance" kind="function" signature="function analyzeColorCompliance(hexColor: string): ColorCompliance" path="boatingInstrumentsApp/src/utils/themeCompliance.ts"/>
    <item name="ColorCompliance" kind="interface" signature="interface ColorCompliance { isRedNightSafe: boolean; hasBlueGreenLight: boolean; wavelengthRange: string; marineSafetyLevel: 'safe' | 'warning' | 'unsafe'; recommendation?: string; }" path="boatingInstrumentsApp/src/utils/themeCompliance.ts"/>
    <item name="ThemeSwitcher" kind="component" signature="React.FC" path="boatingInstrumentsApp/src/widgets/ThemeSwitcher.tsx"/>
    <item name="hexToRgb" kind="function" signature="function hexToRgb(hex: string): RGBColor | null" path="boatingInstrumentsApp/src/utils/themeCompliance.ts"/>
  </interfaces>
  
  <tests>
    <standards>Jest testing framework with React Native Testing Library. Marine safety compliance testing with RGB color analysis. Theme switching performance testing with timing measurements. Native brightness control testing across platforms. Visual consistency validation for traditional marine equipment aesthetics.</standards>
    <locations>
      - __tests__/themeCompliance.test.ts (comprehensive marine safety compliance tests - 11 tests passing)
      - __tests__/store/themeStore.test.ts (theme state management and persistence tests)
      - __tests__/widgets/ThemeSwitcher.test.tsx (theme switching UI functionality tests)
      - __tests__/integration/themeIntegration.test.tsx (existing widget theme inheritance tests)
      - __tests__/performance/themeSwitching.test.ts (theme switch timing and performance tests)
    </locations>
    <ideas>
      <item ac="1-4">Theme mode implementation tests (day/night modes, brightness levels, settings menu accessibility)</item>
      <item ac="5-8">Integration testing (existing infrastructure compatibility, theme provider pattern, widget inheritance, component integration)</item>
      <item ac="9-11">Quality validation (smooth switching without flicker, performance measurement, traditional marine color scheme verification)</item>
    </ideas>
  </tests>
</story-context>