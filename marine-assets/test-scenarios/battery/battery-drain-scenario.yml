name: "Battery Drain Scenario"
description: "Electrical system monitoring with voltage decline simulation"
duration: 900  # 15 minutes
version: "1.0"
category: "safety"
bridge_mode: "nmea0183"
messageRate: 0.2
scenario_type: "battery"
vessel_type: "Sailboat with Solar"
test_coverage: ["battery", "voltage", "electrical", "alarms", "solar"]

conditions:
  charging_state: "varying"
  solar_available: true
  load_profile: "sailing"

equipment:
  batteries: 5  # House, Port Engine, Stbd Engine, Generator, Thruster
  solar_panels: true
  alternator: true

tags: ["battery", "electrical", "monitoring", "alarms", "solar", "safety", "multi-instance", "location"]
related_stories: ["story-2.6", "epic-2"]

# NMEA sentence definitions for battery monitoring
nmea_sentences:
  # House Battery (Instance 0) - Main battery bank with drain/charge cycle
  - sentence: "$IIXDR,U,{house_voltage},V,BAT_0,I,{house_current},A,BAT_0,C,{house_temp},C,BAT_0_TMP,P,{house_percent},P,BAT_0_SOC,U,12.0,V,BAT_0_NOM,V,400,H,BAT_0_CAP,G,AGM,N,BAT_0_CHEM*XX"
    sentence_type: "XDR"
    description: "House Battery voltage, current, temperature, SOC, nominal voltage, capacity, and chemistry"
    source: "BATTERY_HOUSE"
    interval: 5.0
    type: "XDR"
    parameters:
      house_voltage:
        type: "linear"
        start: 12.6
        end: 11.4
        duration: 420
        then:
          type: "linear"
          start: 11.4
          end: 12.2
          duration: 480
        format: "00.0"
      house_current:
        type: "sine"
        start: -8
        amplitude: 4
        frequency: 0.01
        format: "00.0"
      house_temp:
        type: "sine"
        start: 25
        amplitude: 3
        frequency: 0.005
        format: "00.0"
      house_percent:
        type: "linear"
        start: 95
        end: 45
        duration: 420
        then:
          type: "linear"
          start: 45
          end: 80
          duration: 480
        format: "000"

  # Port Engine Battery (Instance 4) - Port engine starting battery
  - sentence: "$IIXDR,U,{port_voltage},V,BAT_4,I,{port_current},A,BAT_4,C,{port_temp},C,BAT_4_TMP,P,{port_percent},P,BAT_4_SOC,U,12.0,V,BAT_4_NOM,V,100,H,BAT_4_CAP,G,FLA,N,BAT_4_CHEM*XX"
    sentence_type: "XDR"
    description: "Port Engine Battery voltage, current, temperature, SOC, nominal voltage, capacity, and chemistry"
    source: "BATTERY_PORT_ENGINE"
    interval: 5.0
    type: "XDR"
    parameters:
      port_voltage:
        type: "sine"
        start: 12.8
        amplitude: 0.2
        frequency: 0.02
        format: "00.0"
      port_current:
        type: "constant"
        value: 2.5
        format: "00.0"
      port_temp:
        type: "sine"
        start: 28
        amplitude: 2
        frequency: 0.008
        format: "00.0"
      port_percent:
        type: "constant"
        value: 98
        format: "000"

  # Starboard Engine Battery (Instance 5) - Starboard engine starting battery
  - sentence: "$IIXDR,U,{stbd_voltage},V,BAT_5,I,{stbd_current},A,BAT_5,C,{stbd_temp},C,BAT_5_TMP,P,{stbd_percent},P,BAT_5_SOC,U,12.0,V,BAT_5_NOM,V,100,H,BAT_5_CAP,G,FLA,N,BAT_5_CHEM*XX"
    sentence_type: "XDR"
    description: "Starboard Engine Battery voltage, current, temperature, SOC, nominal voltage, capacity, and chemistry"
    source: "BATTERY_STBD_ENGINE"
    interval: 5.0
    type: "XDR"
    parameters:
      stbd_voltage:
        type: "sine"
        start: 12.7
        amplitude: 0.25
        frequency: 0.018
        format: "00.0"
      stbd_current:
        type: "constant"
        value: 2.8
        format: "00.0"
      stbd_temp:
        type: "sine"
        start: 29
        amplitude: 2.5
        frequency: 0.009
        format: "00.0"
      stbd_percent:
        type: "constant"
        value: 97
        format: "000"

  # Generator Battery (Instance 3) - Generator starting battery
  - sentence: "$IIXDR,U,{gen_voltage},V,BAT_3,I,{gen_current},A,BAT_3,C,{gen_temp},C,BAT_3_TMP,P,{gen_percent},P,BAT_3_SOC,U,12.0,V,BAT_3_NOM,V,75,H,BAT_3_CAP,G,AGM,N,BAT_3_CHEM*XX"
    sentence_type: "XDR"
    description: "Generator Battery voltage, current, temperature, SOC, nominal voltage, capacity, and chemistry"
    source: "BATTERY_GENERATOR"
    interval: 5.0
    type: "XDR"
    parameters:
      gen_voltage:
        type: "sine"
        start: 12.9
        amplitude: 0.15
        frequency: 0.015
        format: "00.0"
      gen_current:
        type: "constant"
        value: 1.5
        format: "00.0"
      gen_temp:
        type: "sine"
        start: 27
        amplitude: 2
        frequency: 0.007
        format: "00.0"
      gen_percent:
        type: "constant"
        value: 99
        format: "000"

  # Thruster Battery (Instance 2) - Bow thruster battery with discharge spikes
  - sentence: "$IIXDR,U,{thruster_voltage},V,BAT_2,I,{thruster_current},A,BAT_2,C,{thruster_temp},C,BAT_2_TMP,P,{thruster_percent},P,BAT_2_SOC,U,12.0,V,BAT_2_NOM,V,200,H,BAT_2_CAP,G,LIFEPO4,N,BAT_2_CHEM*XX"
    sentence_type: "XDR"
    description: "Thruster Battery voltage, current, temperature, SOC, nominal voltage, capacity, and chemistry"
    source: "BATTERY_THRUSTER"
    interval: 5.0
    type: "XDR"
    parameters:
      thruster_voltage:
        type: "sine"
        start: 12.5
        amplitude: 0.3
        frequency: 0.015
        format: "00.0"
      thruster_current:
        type: "sine"
        start: -5
        amplitude: 10
        frequency: 0.02
        format: "00.0"
      thruster_temp:
        type: "sine"
        start: 26
        amplitude: 4
        frequency: 0.012
        format: "00.0"
      thruster_percent:
        type: "sine"
        start: 85
        amplitude: 5
        frequency: 0.01
        format: "000"

  # Solar Panel Output
  - sentence: "$IIXDR,A,{solar_current},A,SOLAR_PANEL,U,{solar_voltage},V,SOLAR_PANEL*XX"
    sentence_type: "XDR"
    description: "Solar panel current and voltage output"
    source: "SOLAR_PANEL"
    interval: 5.0
    type: "XDR"
    parameters:
      solar_current:
        type: "sine"
        start: 5
        amplitude: 8
        frequency: 0.005
        format: "00.0"
      solar_voltage:
        type: "sine"
        start: 18
        amplitude: 2
        frequency: 0.008
        format: "00.0"

# Electrical system parameters
parameters:
  electrical_system:
    battery_capacity: 100    # amp hours
    solar_panels: true
    alternator: true
    load_profile: "sailing"  # vs "motoring"
  alarm_thresholds:
    voltage_warning: 12.0    # volts
    voltage_critical: 11.5   # volts
    voltage_emergency: 11.0  # volts

# Battery drain phases
phases:
  - phase: "full_charge"
    duration: 180  # 3 minutes
    description: "Battery at full charge with float charging"
    battery_voltage: [12.6, 12.8]
    charging_status: "FLOAT"
    solar_output: [2, 4]      # amps (maintenance charging)
    alarm_status: "NORMAL"
    
  - phase: "normal_discharge"
    duration: 240  # 4 minutes
    description: "Normal electrical load discharge"
    battery_voltage: [12.2, 12.4]
    charging_status: "DISCHARGING"
    solar_output: [0, 2]      # amps (low solar)
    load_current: [8, 12]     # amps (normal load)
    alarm_status: "NORMAL"
    
  - phase: "low_battery_warning"
    duration: 180  # 3 minutes
    description: "Low battery voltage warning triggered"
    battery_voltage: [11.8, 12.0]
    charging_status: "LOW"
    solar_output: [0, 1]      # amps (minimal solar)
    load_current: [10, 15]    # amps (increased load)
    alarm_status: "WARNING"
    alarm_triggers:
      - time: 0
        type: "BATTERY_WARNING"
        message: "Low battery voltage - 12.0V"
        
  - phase: "critical_battery"
    duration: 120  # 2 minutes
    description: "Critical battery voltage - load shedding recommended"
    battery_voltage: [11.4, 11.6]
    charging_status: "CRITICAL"
    solar_output: [0, 0.5]    # amps (very low solar)
    load_current: [12, 18]    # amps (high load)
    alarm_status: "CRITICAL"
    alarm_triggers:
      - time: 0
        type: "BATTERY_CRITICAL"
        message: "Critical battery voltage - 11.5V"
      - time: 60
        type: "LOAD_SHEDDING"
        message: "Recommend load shedding"
        
  - phase: "solar_recovery"
    duration: 180  # 3 minutes
    description: "Solar charging recovery phase"
    battery_voltage: [11.6, 12.2]
    charging_status: "CHARGING"
    solar_output: [5, 15]     # amps (good solar charging)
    load_current: [6, 10]     # amps (reduced load)
    alarm_status: "RECOVERING"
    alarm_triggers:
      - time: 90
        type: "BATTERY_WARNING_CLEAR"
        message: "Battery voltage recovering - 12.1V"
      - time: 150
        type: "BATTERY_NORMAL"
        message: "Battery voltage normal - 12.2V"

# Data generation with electrical focus
data:
  battery_voltage:
    type: "voltage_profile"
    unit: "volts"
    
  solar_output:
    type: "solar_simulation" 
    unit: "amps"
    time_of_day_effect: true
    cloud_cover_simulation: true
    
  alternator_output:
    type: "alternator_simulation"
    unit: "amps"
    engine_dependent: true
    
  load_current:
    type: "electrical_load"
    unit: "amps"
    equipment_cycling: true

# Solar panel and alternator charging patterns
charging_patterns:
  solar:
    peak_hours: [10, 16]      # 10 AM to 4 PM
    peak_output: 15           # amps
    cloud_factor: 0.3         # 30% reduction during clouds
    
  alternator:
    output_curve: "rpm_dependent"
    idle_output: 5            # amps at idle
    cruise_output: 25         # amps at cruise RPM
    
# Multi-engine support
multi_engine_config:
  enabled: false  # Set true for twin-engine boats
  alternators:
    port_engine: 25     # amps max
    starboard_engine: 25 # amps max

# NMEA sentence timing
timing:
  electrical: 0.2   # Hz (every 5 seconds)
  alarms: 1        # Hz (alarm broadcasting)

# Electrical system functions
functions:
  voltage_profile: |
    // Battery voltage based on charge state and load
    const currentPhase = getCurrentPhase(currentTime);
    const phaseConfig = phases[currentPhase];
    const [minV, maxV] = phaseConfig.battery_voltage;
    const baseVoltage = (minV + maxV) / 2;
    
    // Add load-dependent voltage drop
    const loadCurrent = getCurrentLoad(currentTime);
    const voltageDrop = loadCurrent * 0.01; // Voltage drop under load
    
    return Math.max(10.5, baseVoltage - voltageDrop);
    
  solar_simulation: |
    // Solar output based on time of day and weather
    const hour = (currentTime / 3600) % 24;
    const solarFactor = Math.max(0, Math.sin((hour - 6) * Math.PI / 12));
    const cloudFactor = Math.random() > 0.7 ? 0.3 : 1.0; // 30% chance of clouds
    const maxOutput = getCurrentPhase(currentTime).solar_output[1];
    
    return maxOutput * solarFactor * cloudFactor;

# Battery alarm configuration
battery_alarms:
  - threshold: 12.0
    type: "WARNING"
    color: "YELLOW"
    message: "Low battery voltage"
    audio: "single_beep"
    frequency: 10  # seconds between beeps
    
  - threshold: 11.5
    type: "CRITICAL"
    color: "RED" 
    message: "Critical battery voltage"
    audio: "double_beep"
    frequency: 5   # seconds between beeps
    
  - threshold: 11.0
    type: "EMERGENCY"
    color: "FLASHING_RED"
    message: "EMERGENCY - Battery voltage critical"
    audio: "continuous_tone"
    frequency: 1   # continuous

# Use cases
use_cases:
  - "Battery voltage monitoring and alarming"
  - "Solar panel charging pattern simulation"
  - "Alternator charging behavior validation"
  - "Electrical load management testing"
  - "Multi-engine electrical system simulation"

# Related acceptance criteria
acceptance_criteria:
  - "AC3: Electrical system monitoring with voltage decline simulation"
  - "AC3: Solar panel and alternator charging pattern simulation"
  - "AC3: Multi-engine support for twin-engine boat scenarios"