/**
 * Legacy Bridge - Temporary Connection
 * 
 * Connects old unit settings dialog to new presentation system
 * until we build the new settings UI.
 * 
 * This allows users to change units immediately while we
 * work on the full Phase 3 settings redesign.
 */

import { useEffect } from 'react';
import { usePresentationStore } from './presentationStore';

// Map old unit system categories to new data categories
const LEGACY_TO_PRESENTATION_MAP: Record<string, { 
  category: 'depth' | 'speed' | 'wind' | 'temperature';
  unitIdMap: Record<string, string>;
}> = {
  depth: {
    category: 'depth',
    unitIdMap: {
      'meter': 'm_1',
      'foot': 'ft_0', 
      'fathom': 'fth_1'
    }
  },
  vessel_speed: {
    category: 'speed',
    unitIdMap: {
      'knots': 'kts_1',
      'kmh': 'kmh_1',
      'mph': 'mph_1'
    }
  },
  wind_speed: {
    category: 'wind', 
    unitIdMap: {
      'knots_wind': 'wind_kts_1',
      'beaufort': 'bf_desc',
      'kmh_wind': 'kmh_0'
    }
  },
  temperature: {
    category: 'temperature',
    unitIdMap: {
      'celsius': 'c_1',
      'fahrenheit': 'f_1'
    }
  }
};

/**
 * Hook to sync legacy unit preferences with new presentation system
 * 
 * Call this in a high-level component to bridge the systems.
 * Remove once Phase 3 (new settings UI) is complete.
 */
export function useLegacyUnitBridge() {
  const setPresentationForCategory = usePresentationStore(state => state.setPresentationForCategory);
  
  useEffect(() => {
    // Import legacy settings and sync with presentation store
    const syncLegacySettings = async () => {
      try {
        // Get legacy unit preferences from storage
        const { AsyncStorage } = await import('@react-native-async-storage/async-storage');
        const legacyPrefsString = await AsyncStorage.getItem('unit-preferences');
        
        if (legacyPrefsString) {
          const legacyPrefs = JSON.parse(legacyPrefsString);
          
          // Map legacy preferences to presentation system
          Object.entries(LEGACY_TO_PRESENTATION_MAP).forEach(([legacyCategory, mapping]) => {
            const legacyUnitId = legacyPrefs[legacyCategory];
            if (legacyUnitId && mapping.unitIdMap[legacyUnitId]) {
              const presentationId = mapping.unitIdMap[legacyUnitId];
              setPresentationForCategory(mapping.category, presentationId);
            }
          });
        }
      } catch (error) {
        console.warn('[LegacyBridge] Failed to sync legacy settings:', error);
      }
    };
    
    syncLegacySettings();
  }, [setPresentationForCategory]);
}

/**
 * Sync changes from legacy system to presentation system
 * 
 * Call this when legacy settings change to update presentation system.
 */
export function syncLegacyUnitChange(legacyCategory: string, legacyUnitId: string) {
  console.log(`ðŸ”§ [LegacyBridge] Syncing: ${legacyCategory} -> ${legacyUnitId}`);
  
  const mapping = LEGACY_TO_PRESENTATION_MAP[legacyCategory];
  if (mapping && mapping.unitIdMap[legacyUnitId]) {
    const presentationId = mapping.unitIdMap[legacyUnitId];
    console.log(`ðŸ”„ [LegacyBridge] Mapped to presentation: ${mapping.category} -> ${presentationId}`);
    
    // Update presentation store
    const store = usePresentationStore.getState();
    store.setPresentationForCategory(mapping.category, presentationId);
    console.log(`âœ… [LegacyBridge] Updated presentation store`);
  } else {
    console.warn(`âš ï¸ [LegacyBridge] No mapping found for ${legacyCategory} -> ${legacyUnitId}`);
  }
}
