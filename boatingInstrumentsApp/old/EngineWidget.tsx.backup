import React, { useState, useMemo } from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { SimpleWidget } from '../components/atoms';
import { useNmeaStore } from '../store/nmeaStore';
import { useTheme } from '../store/themeStore';
import { createThemedStyles, getStateColor } from '../theme/styles/theme.stylesheet';
import { useWidgetExpanded } from '../hooks/useWidgetExpanded';

interface EngineWidgetProps {
  engineId?: 'port' | 'starboard' | 'main';
  showMultipleEngines?: boolean;
  widgetId?: string; // For layout persistence
}

export const EngineWidget: React.FC<EngineWidgetProps> = ({ 
  engineId = 'main',
  showMultipleEngines = false,
  widgetId = 'engine-widget'
}) => {
  const engine = useNmeaStore((state: any) => state.nmeaData.engine);
  const theme = useTheme();
  const styles = useMemo(() => createThemedStyles(theme), [theme]);
  
  // AC 3: State persists per widget in layout storage
  const [expanded, toggleExpanded] = useWidgetExpanded(widgetId);

  // Engine data with defaults and multiple engine support
  const engineData = engine?.[engineId] || engine || {};
  const {
    rpm = undefined,
    coolantTemp = undefined,
    oilPressure = undefined,
    fuelFlow = undefined,
    engineHours = undefined,
    alternatorVoltage = undefined,
    boostPressure = undefined,
    engineLoad = undefined
  } = engineData;

  // Marine safety thresholds - Conservative for reliability
  const RPM_CAUTION = 2000;  // Orange warning threshold
  const RPM_CRITICAL = 3800; // Red alarm threshold
  const RPM_OVERREV = 4200;  // Flashing red critical
  
  const getWidgetState = () => {
    if (rpm === undefined) return 'no-data';
    
    // Critical alarms - immediate attention required
    if (coolantTemp > 100 || oilPressure < 5 || rpm > RPM_OVERREV) return 'alarm';
    
    // Warning conditions - attention needed
    if (coolantTemp > 90 || oilPressure < 10 || rpm > RPM_CRITICAL) return 'highlighted';
    
    return 'normal';
  };

  // Individual metric state functions for PrimaryMetricCell
  const getRpmState = () => {
    if (rpm === undefined) return 'normal';
    if (rpm > RPM_OVERREV) return 'alarm';
    if (rpm > RPM_CRITICAL) return 'warning';
    return 'normal';
  };

  const getTempState = () => {
    if (coolantTemp === undefined) return 'normal';
    if (coolantTemp > 100) return 'alarm';
    if (coolantTemp > 90) return 'warning';
    return 'normal';
  };

  const getPressureState = () => {
    if (oilPressure === undefined) return 'normal';
    if (oilPressure < 5) return 'alarm';
    if (oilPressure < 10) return 'warning';
    return 'normal';
  };

  const getRpmDisplay = () => {
    if (rpm === undefined) return '---';
    
    const state = getWidgetState();
    const rpmText = Math.round(rpm).toString();
    
    // Add flashing effect for over-rev
    if (state === 'alarm' && rpm > RPM_OVERREV) {
      return rpmText; // Flashing handled by widget state
    }
    
    return rpmText;
  };

  const getEngineStatus = () => {
    if (rpm === undefined) return 'No Engine Data';
    if (rpm === 0) return 'Engine Off';
    if (rpm > RPM_OVERREV) return 'OVER-REV!';
    if (rpm > RPM_CRITICAL) return 'High RPM';
    if (rpm > RPM_CAUTION) return 'Elevated RPM';
    if (rpm < 500) return 'Idle';
    return 'Running';
  };

  const formatEngineHours = (hours: number) => {
    if (hours < 100) return `${hours.toFixed(1)}h`;
    return `${Math.round(hours)}h`;
  };

  // Removed renderCollapsedView - now using SimpleWidget

  // Removed renderExpandedView - now using SimpleWidget

  // Legacy render function for reference - to be removed
  const renderDetails = () => (
    <View style={styles.spacer}>
      <View style={styles.gridRow}>
        <Text style={styles.secondary}>Fuel Flow:</Text>
        <Text style={styles.valueSmall}>
          {fuelFlow !== undefined ? `${fuelFlow.toFixed(1)} L/h` : '--'}
        </Text>
      </View>
      
      <View style={styles.gridRow}>
        <Text style={styles.secondary}>Alternator:</Text>
        <Text style={styles.valueSmall}>
          {alternatorVoltage !== undefined ? `${alternatorVoltage.toFixed(1)}V` : '--'}
        </Text>
      </View>
      
      <View style={styles.gridRow}>
        <Text style={styles.secondary}>Boost:</Text>
        <Text style={styles.valueSmall}>
          {boostPressure !== undefined ? `${boostPressure.toFixed(1)} psi` : '--'}
        </Text>
      </View>
      
      <View style={styles.gridRow}>
        <Text style={styles.secondary}>Load:</Text>
        <Text style={styles.valueSmall}>
          {engineLoad !== undefined ? `${Math.round(engineLoad)}%` : '--'}
        </Text>
      </View>
    </View>
  );

  const title = showMultipleEngines ? 
    `Engine ${engineId.charAt(0).toUpperCase() + engineId.slice(1)}` : 
    'Engine';

  // AC 2: Handle tap to toggle expanded state
  const handleToggleExpanded = () => {
    toggleExpanded();
  };

  // Map widget state to SimpleWidget state
  const getSimpleWidgetState = (): 'normal' | 'warning' | 'alarm' | 'no-data' => {
    const state = getWidgetState();
    switch (state) {
      case 'highlighted': return 'warning';
      default: return state as 'normal' | 'warning' | 'alarm' | 'no-data';
    }
  };

  // Simple metric display for expanded view
  const MetricRow = ({ label, value, unit, state = 'normal' }: { 
    label: string; 
    value: string; 
    unit: string; 
    state?: 'normal' | 'warning' | 'alarm' 
  }) => (
    <View style={styles.simpleMetricRow}>
      <Text style={[styles.simpleMetricLabel, { color: theme.textSecondary }]}>{label}</Text>
      <View style={styles.simpleMetricValue}>
        <Text style={[
          styles.simpleMetricNumber, 
          { color: state === 'alarm' ? theme.error : state === 'warning' ? theme.warning : theme.text }
        ]}>
          {value}
        </Text>
        <Text style={[styles.simpleMetricUnit, { color: theme.textSecondary }]}> {unit}</Text>
      </View>
    </View>
  );

  const expandedContent = (
    <View style={styles.metricsContainer}>
      <MetricRow 
        label="Temperature" 
        value={coolantTemp !== undefined ? Math.round(coolantTemp).toString() : '---'} 
        unit="°C" 
        state={getTempState()} 
      />
      <MetricRow 
        label="Oil Pressure" 
        value={oilPressure !== undefined ? oilPressure.toFixed(1) : '---'} 
        unit="bar" 
        state={getPressureState()} 
      />
      {expanded && engineHours !== undefined && (
        <MetricRow 
          label="Engine Hours" 
          value={formatEngineHours(engineHours)} 
          unit="" 
        />
      )}
      {expanded && fuelFlow !== undefined && (
        <MetricRow 
          label="Fuel Flow" 
          value={fuelFlow.toFixed(1)} 
          unit="L/h" 
        />
      )}
    </View>
  );

  return (
    <SimpleWidget
      title={title}
      icon="car-outline"
      value={getRpmDisplay()}
      unit="rpm"
      state={getSimpleWidgetState()}
      secondary={getEngineStatus()}
      expanded={expanded}
      onToggle={handleToggleExpanded}
      testID={widgetId}
      hasInteractiveContent={false}
    >
      {expandedContent}
    </SimpleWidget>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  metricsContainer: {
    paddingTop: 8,
  },
  simpleMetricRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 4,
  },
  simpleMetricLabel: {
    fontSize: 12,
    fontWeight: '500',
    flex: 1,
  },
  simpleMetricValue: {
    flexDirection: 'row',
    alignItems: 'baseline',
  },
  simpleMetricNumber: {
    fontSize: 16,
    fontWeight: '600',
  },
  simpleMetricUnit: {
    fontSize: 12,
    fontWeight: '500',
  },
  overview: {
    alignItems: 'center',
    paddingVertical: 8,
  },
  primaryRow: {
    alignItems: 'center',
    marginBottom: 8,
  },
  rpmValue: {
    fontSize: 32,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
  rpmLabel: {
    fontSize: 12,
    marginTop: -4,
  },
  secondaryRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    width: '100%',
    marginBottom: 8,
  },
  metric: {
    alignItems: 'center',
  },
  metricValue: {
    fontSize: 18,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
  metricLabel: {
    fontSize: 10,
    marginTop: 2,
  },
  hours: {
    fontSize: 11,
    fontStyle: 'italic',
  },
  details: {
    paddingVertical: 8,
  },
  detailRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 4,
  },
  detailLabel: {
    fontSize: 12,
  },
  detailValue: {
    fontSize: 12,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
  unitLabel: {
    fontSize: 14,
    marginLeft: 4,
    // Color now set dynamically using theme
  },
  statusText: {
    fontSize: 13,
    fontWeight: '600',
    marginVertical: 4,
    textAlign: 'center',
  },
  // AC 7: Four metrics: 2×2 grid
  // AC 9: Grid cells equal-sized, 8pt gap between cells
  gridContainer: {
    width: '100%',
    paddingHorizontal: 4,
  },
  gridRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 4, // 8pt gap between rows
  },
  gridCell: {
    flex: 1,
    marginHorizontal: 4, // 8pt gap between cells
  },
  // AC 9: Single cell centered in collapsed view
  collapsedCenterCell: {
    flex: 0.6, // Narrower than full row
    alignSelf: 'center',
  },
  // AC 16: Expanded view additional metrics
  expandedMetrics: {
    marginTop: 8,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: 'rgba(255, 255, 255, 0.1)',
  },
  expandedLabel: {
    fontSize: 11,
    fontWeight: '600',
    textAlign: 'center',
    marginBottom: 8,
  },
  expandedGrid: {
    width: '100%',
    paddingHorizontal: 4,
  },
});
