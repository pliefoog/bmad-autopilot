import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { useNmeaStore } from '../store/nmeaStore';
import { useTheme } from '../store/themeStore';
import { useWidgetStore } from '../store/widgetStore';
import PrimaryMetricCell from '../components/PrimaryMetricCell';
import SecondaryMetricCell from '../components/SecondaryMetricCell';

interface BatteryWidgetProps {
  id: string;
  title: string;
}

/**
 * Battery Widget - Multi-Instance Battery Display per ui-architecture.md v2.3
 * Primary Grid (2Ã—2): VOLT, CURR, TEMP, SOC
 * Secondary Grid (1Ã—3): Nominal Voltage, Capacity, Chemistry
 * Supports multi-instance detection via NMEA battery instances
 */
export const BatteryWidget: React.FC<BatteryWidgetProps> = ({ id, title }) => {
  const battery = useNmeaStore((state: any) => state.nmeaData.battery);
  const theme = useTheme();
  const { setWidgetExpanded, widgetExpanded, isWidgetPinned } = useWidgetStore();
  
  const [isPinned, setIsPinned] = useState(false);
  const isExpanded = widgetExpanded[id] || false;

  // Extract battery data with defaults for multi-instance support
  const {
    house = null,
    engine = null,
    current = null,
    temperature = null,
    stateOfCharge = null,
    nominalVoltage = 12.0,
    capacity = null,
    chemistry = 'Unknown'
  } = battery || {};

  // Marine safety thresholds for battery monitoring
  const getBatteryState = useCallback((voltage: number | null) => {
    if (voltage === null || voltage === undefined) return 'warning';
    if (voltage < 11.5) return 'critical'; // Deep discharge danger
    if (voltage < 12.0) return 'warning';   // Low battery warning
    if (voltage > 14.8) return 'warning';   // Overcharge warning
    return 'normal';
  }, []);

  // Determine primary voltage source (house takes priority)
  const primaryVoltage = house || engine || null;
  const voltageState = getBatteryState(primaryVoltage);
  const isStale = !battery; // No battery data available

  // Widget interaction handlers
  const handlePress = useCallback(() => {
    setWidgetExpanded(id, !isExpanded);
  }, [id, isExpanded, setWidgetExpanded]);

  const handleLongPressOnCaret = useCallback(() => {
    setIsPinned(!isPinned);
  }, [isPinned]);

  // Format values for display
  const formatVoltage = (voltage: number | null) => voltage?.toFixed(1) || '--';
  const formatCurrent = (current: number | null) => current?.toFixed(1) || '--';
  const formatTemperature = (temp: number | null) => temp?.toFixed(0) || '--';
  const formatSOC = (soc: number | null) => soc?.toFixed(0) || '--';
  const formatCapacity = (cap: number | null) => cap?.toFixed(0) || '--';

  return (
    <TouchableOpacity
      style={[styles.container, { backgroundColor: theme.surface }]}
      onPress={handlePress}
      activeOpacity={0.7}
      testID={`battery-widget-${id}`}
    >
      {/* Widget Header */}
      <View style={styles.header}>
        <Text style={[styles.title, { color: theme.textSecondary }]}>
          {title}
        </Text>
        <View style={styles.controls}>
          {isPinned && (
            <TouchableOpacity
              onLongPress={handleLongPressOnCaret}
              activeOpacity={0.7}
              testID={`pin-button-${id}`}
            >
              <Text style={[styles.pinIcon, { color: theme.primary }]}>ðŸ“Œ</Text>
            </TouchableOpacity>
          )}
          <TouchableOpacity
            onPress={handlePress}
            onLongPress={handleLongPressOnCaret}
            activeOpacity={0.7}
            testID={`caret-button-${id}`}
          >
            <Text style={[styles.caret, { color: theme.textSecondary }]}>
              {isExpanded ? 'âŒƒ' : 'âŒ„'}
            </Text>
          </TouchableOpacity>
        </View>
      </View>

      {/* Primary Grid (2Ã—2): VOLT, CURR, TEMP, SOC */}
      <View style={styles.primaryGrid}>
        <PrimaryMetricCell
          mnemonic="VOLT"
          value={formatVoltage(primaryVoltage)}
          unit="V"
          state={isStale ? 'warning' : voltageState}
        />
        <PrimaryMetricCell
          mnemonic="CURR"
          value={formatCurrent(current)}
          unit="A"
          state={isStale ? 'warning' : 'normal'}
        />
        <PrimaryMetricCell
          mnemonic="TEMP"
          value={formatTemperature(temperature)}
          unit="Â°C"
          state={isStale ? 'warning' : 'normal'}
        />
        <PrimaryMetricCell
          mnemonic="SOC"
          value={formatSOC(stateOfCharge)}
          unit="%"
          state={isStale ? 'warning' : 'normal'}
        />
      </View>

      {/* Secondary Grid (1Ã—3): Nominal Voltage, Capacity, Chemistry */}
      {isExpanded && (
        <View style={styles.secondaryContainer}>
          <View style={styles.secondaryGrid}>
            <SecondaryMetricCell
              mnemonic="NOM V"
              value={nominalVoltage.toFixed(1)}
              unit="V"
              state={isStale ? 'warning' : 'normal'}
              compact={true}
            />
            <SecondaryMetricCell
              mnemonic="CAP"
              value={formatCapacity(capacity)}
              unit="Ah"
              state={isStale ? 'warning' : 'normal'}
              compact={true}
            />
            <SecondaryMetricCell
              mnemonic="CHEM"
              value={chemistry}
              unit=""
              state={isStale ? 'warning' : 'normal'}
              compact={true}
            />
          </View>
        </View>
      )}
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  container: {
    borderRadius: 8,
    padding: 12,
    margin: 4,
    minHeight: 120,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  title: {
    fontSize: 12,
    fontWeight: '600',
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  controls: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  pinIcon: {
    fontSize: 14,
    marginRight: 8,
  },
  caret: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  primaryGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginBottom: 8,
  },
  secondaryContainer: {
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#333',
  },
  secondaryGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
});
    if (house === undefined && engine === undefined) return 'no-data';
    
    const houseCritical = house < 11.5;
    const engineCritical = engine < 11.5;
    const overcharge = house > 14.8 || engine > 14.8;
    
    if (houseCritical || engineCritical || overcharge) return 'alarm';
    
    const houseLow = house < 12.0;
    const engineLow = engine < 12.0;
    
    if (houseLow || engineLow) return 'alarm';
    return 'normal';
  };

  const formatCurrent = (current: number) => {
    if (Math.abs(current) < 0.1) return '0.0A';
    return current > 0 ? `+${current.toFixed(1)}A` : `${current.toFixed(1)}A`;
  };

  const renderOverview = () => (
    <View style={styles.overview}>
      {/* PrimaryMetricCell Grid - 2x1 layout for battery voltages */}
      <View style={styles.metricGrid}>
        <PrimaryMetricCell
          mnemonic="HOUSE"
          value={house !== undefined ? house.toFixed(1) : '---'}
          unit="V"
          state={house !== undefined ? (
            getBatteryStatus(house) === 'critical' || getBatteryStatus(house) === 'low' ? 'alarm' :
            getBatteryStatus(house) === 'high' ? 'warning' : 'normal'
          ) : 'normal'}
          style={styles.metricCell}
        />
        <PrimaryMetricCell
          mnemonic="ENG"
          value={engine !== undefined ? engine.toFixed(1) : '---'}
          unit="V"
          state={engine !== undefined ? (
            getBatteryStatus(engine) === 'critical' || getBatteryStatus(engine) === 'low' ? 'alarm' :
            getBatteryStatus(engine) === 'high' ? 'warning' : 'normal'
          ) : 'normal'}
          style={styles.metricCell}
        />
      </View>

      {/* State of Charge Row */}
      {(houseStateOfCharge !== undefined || engineStateOfCharge !== undefined) && (
        <View style={styles.socRow}>
          {houseStateOfCharge !== undefined && (
            <Text style={[styles.socText, { color: theme.textSecondary }]}>
              House: {Math.round(houseStateOfCharge)}%
            </Text>
          )}
          {engineStateOfCharge !== undefined && (
            <Text style={[styles.socText, { color: theme.textSecondary }]}>
              Engine: {Math.round(engineStateOfCharge)}%
            </Text>
          )}
        </View>
      )}

      {/* Current Draw */}
      {houseCurrent !== undefined && (
        <View style={styles.currentRow}>
          <Text style={[styles.currentLabel, { color: theme.textSecondary }]}>
            House Current: 
          </Text>
          <Text style={[styles.currentValue, { 
            color: houseCurrent > 0 ? theme.success : houseCurrent < -5 ? theme.warning : theme.text 
          }]}>
            {formatCurrent(houseCurrent)}
          </Text>
        </View>
      )}

      {/* Alternator Output */}
      {alternatorOutput !== undefined && (
        <Text style={[styles.alternatorText, { color: theme.textSecondary }]}>
          Alt: {alternatorOutput.toFixed(1)}A
        </Text>
      )}
    </View>
  );

  const renderDetails = () => (
    <View style={styles.details}>
      <View style={styles.detailRow}>
        <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Charging:</Text>
        <Text style={[styles.detailValue, { color: theme.text }]}>
          {chargingStatus || 'Unknown'}
        </Text>
      </View>
      
      {temperature !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Temperature:</Text>
          <Text style={[styles.detailValue, { color: theme.text }]}>
            {temperature.toFixed(1)}Â°C
          </Text>
        </View>
      )}
      
      {bow !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Bow Thruster:</Text>
          <Text style={[styles.detailValue, { color: getStatusColor(bow) }]}>
            {bow.toFixed(1)}V
          </Text>
        </View>
      )}
    </View>
  );

  return (
    <TouchableOpacity 
      onPress={() => setSelectedView(selectedView === 'overview' ? 'details' : 'overview')}
      style={styles.container}
    >
      <WidgetCard 
        title="Battery"
        icon="battery-charging-outline"
        state={getWidgetState()}
      >
        {selectedView === 'overview' ? renderOverview() : renderDetails()}
      </WidgetCard>
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  overview: {
    paddingVertical: 8,
  },
  metricGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    paddingHorizontal: 4,
    paddingVertical: 8,
  },
  metricCell: {
    flex: 1,
    marginHorizontal: 4,
  },
  socRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginVertical: 4,
  },
  socText: {
    fontSize: 12,
    fontWeight: '500',
  },
  batteryRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 8,
  },
  batteryBank: {
    alignItems: 'center',
    flex: 1,
  },
  bankLabel: {
    fontSize: 10,
    marginBottom: 4,
  },
  voltageValue: {
    fontSize: 20,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
  socValue: {
    fontSize: 11,
    marginTop: 2,
  },
  currentRow: {
    flexDirection: 'row',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 4,
  },
  currentLabel: {
    fontSize: 11,
  },
  currentValue: {
    fontSize: 11,
    fontWeight: 'bold',
    marginLeft: 4,
    fontFamily: 'monospace',
  },
  alternatorText: {
    fontSize: 11,
    textAlign: 'center',
  },
  details: {
    paddingVertical: 8,
  },
  detailRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 4,
  },
  detailLabel: {
    fontSize: 12,
  },
  detailValue: {
    fontSize: 12,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
});
