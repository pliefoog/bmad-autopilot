import React, { useState } from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { WidgetCard } from './WidgetCard';
import { PrimaryMetricCell } from '../components/PrimaryMetricCell';
import { useNmeaStore } from '../store/nmeaStore';
import { useTheme } from '../store/themeStore';
import Svg, { Rect, Path } from 'react-native-svg';

interface TanksWidgetProps {
  showUsageRate?: boolean;
}

export const TanksWidget: React.FC<TanksWidgetProps> = ({ showUsageRate = true }) => {
  const tanks = useNmeaStore((state: any) => state.nmeaData.tanks);
  const theme = useTheme();
  const [selectedView, setSelectedView] = useState<'overview' | 'details'>('overview');

  // Tank data with defaults
  const {
    fuel = undefined,
    freshWater = undefined,
    wasteWater = undefined,
    grayWater = undefined,
    blackWater = undefined,
    fuelUsageRate = undefined,
    waterUsageRate = undefined,
    fuelCapacity = undefined,
    waterCapacity = undefined
  } = tanks || {};

  // Marine safety thresholds
  const getTankStatus = (level: number, type: 'fuel' | 'water' | 'waste') => {
    if (type === 'fuel') {
      if (level < 10) return 'critical'; // Reserve fuel
      if (level < 25) return 'low';
      return 'normal';
    } else if (type === 'water') {
      if (level < 15) return 'low';
      return 'normal';
    } else { // waste
      if (level > 90) return 'critical'; // Need pumpout
      if (level > 75) return 'high';
      return 'normal';
    }
  };

  const getStatusColor = (level: number, type: 'fuel' | 'water' | 'waste') => {
    const status = getTankStatus(level, type);
    switch (status) {
      case 'critical': return theme.error;
      case 'low': return theme.warning;
      case 'high': return theme.warning;
      default: return theme.success;
    }
  };

  const getWidgetState = () => {
    if (fuel === undefined && freshWater === undefined && wasteWater === undefined) return 'no-data';
    
    const fuelCritical = fuel < 10;
    const waterLow = freshWater < 15;
    const wasteFull = wasteWater > 90;
    
    if (fuelCritical || wasteFull) return 'alarm';
    if (fuel < 25 || waterLow || wasteWater > 75) return 'alarm';
    return 'normal';
  };

  const TankGauge: React.FC<{ level: number; color: string; type: string }> = ({ level, color, type }) => (
    <View style={styles.gauge}>
      <Svg width={40} height={60} viewBox="0 0 40 60">
        {/* Tank outline */}
        <Rect x={5} y={5} width={30} height={50} rx={3} fill="none" stroke={theme.border} strokeWidth={1.5} />
        {/* Fill level */}
        <Rect 
          x={7} 
          y={7 + (48 * (100 - level) / 100)} 
          width={26} 
          height={48 * level / 100} 
          rx={1} 
          fill={color} 
          opacity={0.7}
        />
        {/* Level markers */}
        <Path d={`M5 ${5 + 12} L35 ${5 + 12}`} stroke={theme.border} strokeWidth={0.5} opacity={0.5} />
        <Path d={`M5 ${5 + 24} L35 ${5 + 24}`} stroke={theme.border} strokeWidth={0.5} opacity={0.5} />
        <Path d={`M5 ${5 + 36} L35 ${5 + 36}`} stroke={theme.border} strokeWidth={0.5} opacity={0.5} />
      </Svg>
      <Text style={[styles.gaugeLabel, { color: theme.textSecondary }]}>{type}</Text>
    </View>
  );

  // Get metric state for tank levels
  const getTankMetricState = (level: number | undefined, type: 'fuel' | 'water' | 'waste'): 'normal' | 'warning' | 'alarm' | undefined => {
    if (level === undefined) return undefined;
    const status = getTankStatus(level, type);
    switch (status) {
      case 'critical': return 'alarm';
      case 'low': return 'warning';
      case 'high': return 'warning';
      default: return 'normal';
    }
  };

  const renderOverview = () => (
    <View style={styles.overview}>
      <View style={styles.metricGrid}>
        {fuel !== undefined && (
          <PrimaryMetricCell
            mnemonic="FUEL"
            value={Math.round(fuel).toString()}
            unit="%"
            state={getTankMetricState(fuel, 'fuel')}
            style={styles.metricCell}
          />
        )}
        
        {freshWater !== undefined && (
          <PrimaryMetricCell
            mnemonic="H2O"
            value={Math.round(freshWater).toString()}
            unit="%"
            state={getTankMetricState(freshWater, 'water')}
            style={styles.metricCell}
          />
        )}
        
        {wasteWater !== undefined && (
          <PrimaryMetricCell
            mnemonic="WASTE"
            value={Math.round(wasteWater).toString()}
            unit="%"
            state={getTankMetricState(wasteWater, 'waste')}
            style={styles.metricCell}
          />
        )}
      </View>

      <View style={styles.tanksRow}>
        {fuel !== undefined && (
          <View style={styles.tankItem}>
            <TankGauge level={fuel} color={getStatusColor(fuel, 'fuel')} type="FUEL" />
          </View>
        )}
        
        {freshWater !== undefined && (
          <View style={styles.tankItem}>
            <TankGauge level={freshWater} color={getStatusColor(freshWater, 'water')} type="H2O" />
          </View>
        )}
        
        {wasteWater !== undefined && (
          <View style={styles.tankItem}>
            <TankGauge level={wasteWater} color={getStatusColor(wasteWater, 'waste')} type="WASTE" />
          </View>
        )}
      </View>

      {(fuelUsageRate !== undefined || waterUsageRate !== undefined) && showUsageRate && (
        <View style={styles.usageRow}>
          {fuelUsageRate !== undefined && (
            <Text style={[styles.usageText, { color: theme.textSecondary }]}>
              Fuel: {fuelUsageRate.toFixed(1)} L/h
            </Text>
          )}
          {waterUsageRate !== undefined && (
            <Text style={[styles.usageText, { color: theme.textSecondary }]}>
              Water: {waterUsageRate.toFixed(1)} L/h
            </Text>
          )}
        </View>
      )}
    </View>
  );

  const renderDetails = () => (
    <View style={styles.details}>
      {fuelCapacity !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Fuel Capacity:</Text>
          <Text style={[styles.detailValue, { color: theme.text }]}>
            {fuelCapacity.toFixed(0)}L
          </Text>
        </View>
      )}
      
      {waterCapacity !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Water Capacity:</Text>
          <Text style={[styles.detailValue, { color: theme.text }]}>
            {waterCapacity.toFixed(0)}L
          </Text>
        </View>
      )}
      
      {grayWater !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Gray Water:</Text>
          <Text style={[styles.detailValue, { color: theme.text }]}>
            {Math.round(grayWater)}%
          </Text>
        </View>
      )}
      
      {blackWater !== undefined && (
        <View style={styles.detailRow}>
          <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>Black Water:</Text>
          <Text style={[styles.detailValue, { color: theme.text }]}>
            {Math.round(blackWater)}%
          </Text>
        </View>
      )}
    </View>
  );

  return (
    <TouchableOpacity 
      onPress={() => setSelectedView(selectedView === 'overview' ? 'details' : 'overview')}
      style={styles.container}
    >
      <WidgetCard 
        title="Tanks"
        icon="cube-outline"
        state={getWidgetState()}
      >
        {selectedView === 'overview' ? renderOverview() : renderDetails()}
      </WidgetCard>
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  metricGrid: {
    flexDirection: 'row',
    flex: 1,
    marginBottom: 8,
  },
  metricCell: {
    flex: 1,
  },
  overview: {
    paddingVertical: 8,
  },
  tanksRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 8,
  },
  tankItem: {
    alignItems: 'center',
    flex: 1,
  },
  gauge: {
    alignItems: 'center',
    marginBottom: 4,
  },
  gaugeLabel: {
    fontSize: 9,
    marginTop: 2,
  },
  tankValue: {
    fontSize: 14,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
  usageRow: {
    alignItems: 'center',
  },
  usageText: {
    fontSize: 10,
    marginVertical: 1,
  },
  details: {
    paddingVertical: 8,
  },
  detailRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 4,
  },
  detailLabel: {
    fontSize: 12,
  },
  detailValue: {
    fontSize: 12,
    fontWeight: 'bold',
    fontFamily: 'monospace',
  },
});
