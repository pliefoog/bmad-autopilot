# Fuel Widget Validation Scenario
# Epic 11 - Professional Grade Testing Architecture
# Story 11.2 - Widget-Scenario Mapping
# Domain: Engine - Fuel System Monitoring

name: "fuel-widget-validation"
description: "Comprehensive fuel widget validation with tank monitoring, consumption tracking, and marine safety standards"
version: "1.0.0"
category: "engine"
domain: "fuel-systems"
duration: 180000  # 3 minutes

# Marine Domain Accuracy Requirements
accuracy_standards:
  tank_level_precision: 0.1  # 0.1% precision for tank levels
  consumption_rate_precision: 0.01  # 0.01 gallons/hour precision
  flow_rate_precision: 0.1  # 0.1 GPH precision
  manufacturer_tolerance: "within_spec"
  staleness_threshold: 5000  # 5 seconds

# Integration with Triple-Tier Testing Architecture
testing_tiers:
  tier1_unit: "fuel-widget.test.js"
  tier2_api_injection: "fuel-nmea-injection.test.js"
  tier3_scenario_integration: "this_scenario"

# NMEA Sentence Configuration for Fuel Monitoring
nmea_sentences:
  primary:
    - type: "RSA"  # Rudder Sensor Angle (used for tank levels in many systems)
      purpose: "Tank level monitoring"
      parameters:
        - "starboard_rudder"  # Tank 1 level
        - "port_rudder"      # Tank 2 level
      frequency: 1000  # 1 Hz
      
    - type: "XDR"  # Transducer Measurement
      purpose: "Fuel flow and consumption data"
      parameters:
        - "fuel_flow_rate"
        - "fuel_pressure"
        - "fuel_temperature"
        - "fuel_consumption_rate"
      frequency: 2000  # 0.5 Hz

  secondary:
    - type: "VLW"  # Distance Traveled through Water
      purpose: "Fuel efficiency calculations"
      parameters:
        - "total_cumulative_distance"
        - "distance_since_reset"
      frequency: 5000  # 0.2 Hz

# Test Phases for Fuel Widget Validation
test_phases:
  
  # Phase 1: Tank Level Monitoring
  phase_1_tank_levels:
    name: "Tank Level Accuracy Validation"
    duration: 45000  # 45 seconds
    objective: "Validate fuel tank level readings within 0.1% precision"
    
    nmea_data:
      - sentence: "RSA"
        data:
          - timestamp: 0
            values: [85.5, 72.3]  # Tank 1: 85.5%, Tank 2: 72.3%
          - timestamp: 5000
            values: [85.3, 72.1]  # Slight decrease
          - timestamp: 10000
            values: [85.0, 71.8]  # Continued consumption
          - timestamp: 15000
            values: [84.8, 71.6]
          - timestamp: 20000
            values: [84.5, 71.3]
            
    expected_behavior:
      tank_1_level: 
        - range: [84.5, 85.5]
        - precision: 0.1
        - units: "percentage"
      tank_2_level:
        - range: [71.3, 72.3] 
        - precision: 0.1
        - units: "percentage"
      total_fuel_remaining:
        - calculation: "tank_1 + tank_2 levels combined"
        - accuracy: "within 0.1% of actual"
        
    validation_criteria:
      - "Tank level displays update within 100ms of NMEA sentence receipt"
      - "Level percentage accurate within 0.1% precision"
      - "Multiple tank support functional and accurate"
      - "Visual fuel gauge reflects numeric values correctly"

  # Phase 2: Fuel Flow and Consumption
  phase_2_fuel_consumption:
    name: "Fuel Flow and Consumption Tracking"
    duration: 60000  # 60 seconds  
    objective: "Validate fuel consumption tracking within 0.01 GPH precision"
    
    nmea_data:
      - sentence: "XDR"
        data:
          - timestamp: 45000
            values: ["F", 12.5, "G", "FUEL_FLOW"]  # 12.5 GPH flow rate
          - timestamp: 50000  
            values: ["F", 12.8, "G", "FUEL_FLOW"]  # Increased flow
          - timestamp: 55000
            values: ["F", 12.3, "G", "FUEL_FLOW"]  # Decreased flow
          - timestamp: 60000
            values: ["F", 12.6, "G", "FUEL_FLOW"]  # Stabilized flow
            
    expected_behavior:
      fuel_flow_rate:
        - range: [12.3, 12.8]
        - precision: 0.01
        - units: "gallons_per_hour"
      consumption_tracking:
        - calculation: "cumulative fuel used over time"
        - accuracy: "within 0.01 GPH precision"
        
    validation_criteria:
      - "Flow rate updates within 100ms of XDR sentence"
      - "Consumption calculations accurate within 0.01 GPH"
      - "Historical consumption tracking functional"
      - "Fuel efficiency calculations (MPG) accurate"

  # Phase 3: Multiple Tank Monitoring
  phase_3_multi_tank:
    name: "Multiple Fuel Tank Support" 
    duration: 45000  # 45 seconds
    objective: "Validate multi-tank monitoring and switching logic"
    
    nmea_data:
      - sentence: "RSA"
        data:
          - timestamp: 105000
            values: [45.2, 78.9]  # Tank 1 low, Tank 2 high
          - timestamp: 110000
            values: [44.8, 78.6]  
          - timestamp: 115000
            values: [44.5, 78.3]
          - timestamp: 120000
            values: [44.1, 78.0]  # Tank 1 approaching reserve
            
    expected_behavior:
      multi_tank_display:
        - individual_tank_levels: "both tanks displayed separately"
        - total_fuel: "combined calculation accurate"
        - tank_switching: "visual indication of active tank"
      reserve_warnings:
        - low_fuel_threshold: "25% tank level"
        - reserve_threshold: "10% tank level"
        - warning_visibility: "clear visual indicators"
        
    validation_criteria:
      - "Individual tank levels displayed accurately"
      - "Total fuel calculation correct for combined tanks"
      - "Low fuel warnings trigger at correct thresholds"
      - "Tank switching indicators functional (if applicable)"

  # Phase 4: Error Conditions and Edge Cases
  phase_4_error_conditions:
    name: "Fuel System Error Handling"
    duration: 30000  # 30 seconds
    objective: "Validate error handling and data quality resilience"
    
    nmea_data:
      - sentence: "RSA"
        data:
          - timestamp: 150000
            values: [null, 76.5]  # Tank 1 sensor failure
          - timestamp: 155000
            values: ["invalid", 76.2]  # Invalid data
          - timestamp: 160000
            values: [42.3, 76.0]  # Tank 1 recovered
            
      - sentence: "XDR"  # Missing fuel flow data
        data: []  # No fuel flow sentences for 10 seconds
        
    expected_behavior:
      sensor_failure_handling:
        - invalid_data: "ignored, previous valid value retained"
        - missing_sensor: "clear indication of unavailable data"
        - data_staleness: "warning after 5 seconds without updates"
      error_recovery:
        - automatic_recovery: "when valid data resumes"
        - data_validation: "checksum and range verification"
        
    validation_criteria:
      - "Invalid fuel data handled gracefully without crashes"
      - "Missing sensor data clearly indicated to user"
      - "Staleness warnings appear after 5-second threshold" 
      - "Automatic recovery when valid data resumes"
      - "Widget maintains stability during error conditions"

# Performance Thresholds (Marine Safety Requirements)
performance_requirements:
  update_latency: 100  # <100ms NMEA â†’ widget update
  memory_usage: 50     # <50MB max memory for fuel widget
  cpu_usage: 10        # <10% CPU usage during normal operation
  crash_free_rate: 99.5  # 99.5% crash-free session rate

# Validation Metrics for Automated Testing
validation_metrics:
  accuracy_tests:
    - metric: "tank_level_precision"
      target: 0.1
      tolerance: 0.05
    - metric: "fuel_flow_precision" 
      target: 0.01
      tolerance: 0.005
      
  performance_tests:
    - metric: "update_latency_ms"
      target: 100
      max_acceptable: 150
    - metric: "memory_usage_mb"
      target: 50
      max_acceptable: 75
      
  reliability_tests:
    - metric: "error_recovery_time_ms"
      target: 1000
      max_acceptable: 2000
    - metric: "data_staleness_detection_ms"
      target: 5000
      max_acceptable: 6000

# Integration Points with Testing Infrastructure
testing_integration:
  nmea_bridge_simulator:
    - scenario_name: "fuel-system-monitoring"
    - port: 9090
    - api_endpoint: "/api/scenarios/fuel-widget-validation"
    
  triple_tier_architecture:
    - tier_2_injection: "Inject fuel NMEA sentences via API"
    - tier_3_validation: "Full scenario execution with performance measurement"
    - automated_reporting: "Test results exported to JSON/XML"
    
  cross_platform_testing:
    - react_native_web: "WebSocket proxy connection testing"
    - ios_simulator: "Native TCP connection testing"
    - android_emulator: "Native TCP connection testing"

# Expected Test Outcomes
expected_outcomes:
  fuel_widget_accuracy:
    - "Tank level readings accurate within 0.1% precision"
    - "Fuel consumption tracking within 0.01 GPH accuracy"
    - "Multi-tank support with individual and combined calculations"
    
  performance_compliance:
    - "All updates complete within 100ms marine safety requirement"
    - "Memory usage under 50MB during normal operation"
    - "99.5% crash-free rate maintained during testing"
    
  error_resilience:
    - "Graceful handling of sensor failures and invalid data"
    - "Clear user indication of data availability status"
    - "Automatic recovery when valid fuel data resumes"
    - "Staleness detection functional at 5-second threshold"

# Dependencies and Prerequisites  
dependencies:
  required_components:
    - "FuelWidget component (React Native)"
    - "NMEA parsing service with RSA/XDR support"
    - "Multi-tank calculation service"
    - "Marine safety threshold configuration"
    
  test_infrastructure:
    - "NMEA Bridge Simulator with fuel scenario support"
    - "Triple-Tier Testing Architecture (Story 11.1)"
    - "Performance monitoring and measurement tools"
    - "Cross-platform testing environment"